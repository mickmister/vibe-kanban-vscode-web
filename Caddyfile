# Dynamic port forwarding via subdomain: vk-port-<port_num>.* -> localhost:<port_num>
@port_subdomain {
	host_regexp port vk-port-([0-9]+)\..*
}

handle @port_subdomain {
	reverse_proxy localhost:{re.port.1} {
		header_up Host {upstream_hostport}
		header_up Upgrade {http.request.header.Upgrade}
		header_up Connection {http.request.header.Connection}

		@startup_error {
			status 502 503 504
		}
		handle_response @startup_error {
			root * /etc/caddy
			rewrite * /startup.html
			file_server
		}
	}
}

:3001 {

	# Route to VSCode Server if URL has "folder" query parameter
	@vscode_query {
		query folder=*
	}

	# Route to VSCode Server for stable-* paths (VSCode assets)
	@vscode_stable {
		path /stable-*
	}

	# Route to VSCode Server for vscode-remote-resource paths
	@vscode_remote {
		path /vscode-remote-resource*
	}

	# VSCode Server - proxy to code-server on localhost:3008 (query param routing)
	handle @vscode_query {
		reverse_proxy localhost:3008 {
			header_up Host {upstream_hostport}
			# Handle WebSocket connections
			header_up Upgrade {http.request.header.Upgrade}
			header_up Connection {http.request.header.Connection}
		}
	}

	# VSCode Server - proxy to code-server on localhost:3008 (stable-* asset routing)
	handle @vscode_stable {
		reverse_proxy localhost:3008 {
			header_up Host {upstream_hostport}
		}
	}

	# VSCode Server - proxy to code-server on localhost:3008 (vscode-remote-resource routing)
	handle @vscode_remote {
		reverse_proxy localhost:3008 {
			header_up Host {upstream_hostport}
		}
	}

	# Main application - proxy to vibe-kanban on localhost:3007 (fallback)
	handle /* {
		reverse_proxy localhost:3007 {
			# Handle WebSocket connections for hot reload, etc.
			header_up Upgrade {http.request.header.Upgrade}
			header_up Connection {http.request.header.Connection}
		}
	}

	# Enable logging for debugging
	log {
		output stdout
		format console
		level INFO
	}
}
