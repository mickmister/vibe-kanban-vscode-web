# Test Fixtures for Caddy Module Development

This directory contains test fixtures for developing and testing the Vibe Kanban Caddy module that injects JavaScript into HTML responses.

## Directory Structure

```
test-fixtures/
├── Caddyfile.test           # Test server configuration
├── generate-expected.sh      # Script to generate expected injected HTML
├── captured/                 # Original captured responses
│   ├── original.html         # Real Vibe Kanban HTML response
│   └── original-headers.txt  # HTTP response headers
├── expected/                 # Expected output after injection
│   └── injected.html         # HTML with script injected
└── injection-scripts/        # JavaScript files to inject
    └── phase1-test.js        # Phase 1 test injection script
```

## Quick Start

### Generate Expected Output

```bash
cd test-fixtures
./generate-expected.sh
```

This will:
1. Read `injection-scripts/phase1-test.js`
2. Read `captured/original.html`
3. Inject the script before `</body>` tag
4. Output to `expected/injected.html`
5. Validate the injection

### Start Test Server

```bash
# From test-fixtures directory
caddy run --config Caddyfile.test

# Or from project root
caddy run --config test-fixtures/Caddyfile.test
```

The server will start on http://localhost:8081

### Test Endpoints

- **Health Check**: http://localhost:8081/health
- **Original HTML**: http://localhost:8081/original/original.html
- **Expected Injected HTML**: http://localhost:8081/expected/injected.html
- **Injection Script**: http://localhost:8081/injection-scripts/phase1-test.js
- **Index Page**: http://localhost:8081/ (shows all available routes)

## How It Works

### Phase 1: Test Injection Script

The `phase1-test.js` script:
- Sets `window.__CADDY_INJECTION_TEST__ = true`
- Creates `window.__CADDY_INJECTION_METADATA__` with version info
- Logs a console message for verification

### Expected Injection Behavior

The Caddy module should:
1. Detect HTML responses (Content-Type: text/html)
2. Read the configured injection script
3. Inject it inline before the `</body>` tag
4. Preserve all original HTML structure

### Validation

The generation script validates:
- JavaScript syntax is valid
- Script is injected before `</body>` tag
- All script content is present in output
- `</body>` tag is still present
- File sizes are correct

## Development Workflow

1. **Capture Real Response** (Step 1 - Already done)
   - Used Chrome DevTools to capture Vibe Kanban HTML
   - Saved to `captured/original.html`

2. **Create Injection Script** (Step 2 - This step)
   - Created `phase1-test.js` with test markers
   - Generated expected output with `generate-expected.sh`

3. **Build Caddy Module** (Step 3 - Next)
   - Implement injection logic in Go
   - Use test fixtures for validation

4. **Test with Real Server** (Step 4 - Later)
   - Compare module output with expected output
   - Verify injection in browser

## File Details

### captured/original.html
- **Source**: Real Vibe Kanban production build
- **Size**: 721 bytes
- **Content**: Minimal HTML with React app entry point
- **Key Elements**: `<div id="root">`, `</body>` tag

### injection-scripts/phase1-test.js
- **Purpose**: Verify injection works
- **Size**: 362 bytes
- **Features**: Console logging, global flags, metadata

### expected/injected.html
- **Generated By**: `generate-expected.sh`
- **Size**: 1103 bytes (382 bytes added)
- **Structure**: Original HTML + `<script>` tags + injection script + `</body>`

### Caddyfile.test
- **Port**: 8081 (HTTP only)
- **Routes**: 4 endpoint handlers + index page
- **Features**: Debug logging, proper Content-Type headers

## Validation Checklist

Run these commands to verify setup:

```bash
# 1. Check JavaScript syntax
node -c injection-scripts/phase1-test.js

# 2. Generate expected output
./generate-expected.sh

# 3. Validate Caddyfile
caddy validate --config Caddyfile.test

# 4. Check file structure
tree -L 2

# 5. Verify content
grep -l "__CADDY_INJECTION_TEST__" expected/injected.html
```

All checks should pass before proceeding to Caddy module development.

## Next Steps

1. Implement Caddy module in Go
2. Add injection logic
3. Build custom Caddy binary
4. Test with these fixtures
5. Compare output with expected/injected.html

## Notes

- The test server does NOT perform injection - it just serves static files
- The module will be tested separately against this baseline
- Expected output represents what the module SHOULD produce
- All paths in Caddyfile are absolute for reliability
