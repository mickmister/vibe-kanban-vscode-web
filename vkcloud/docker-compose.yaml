# ============================================================================
# Vibe Kanban Cloud Stack - Self-Hosted Deployment
# ============================================================================
#
# This compose file deploys the full VK cloud stack:
# - PostgreSQL (with logical replication for ElectricSQL)
# - ElectricSQL (real-time sync service)
# - Azurite (local Azure Blob Storage emulator for attachments)
# - VK Remote Server (API + frontend)
#
# Quick Start:
# 1. Copy .env.vkcloud.example to .env.vkcloud and configure
# 2. docker-compose -f docker-compose.vkcloud.yaml up -d
# 3. Access at http://localhost:3000 (or your PUBLIC_BASE_URL)
#
# For production deployment:
# - Set PUBLIC_BASE_URL to your public domain (e.g., https://vk.example.com)
# - Configure GitHub OAuth (GITHUB_OAUTH_CLIENT_ID, GITHUB_OAUTH_CLIENT_SECRET)
# - Generate a secure JWT secret (VIBEKANBAN_REMOTE_JWT_SECRET)
# - Set REMOTE_SERVER_PORTS=0.0.0.0:3000:8081 for external access
# - Use a reverse proxy (Caddy, Nginx) for TLS termination
#
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # PostgreSQL Database (with logical replication for ElectricSQL)
  # --------------------------------------------------------------------------
  vk-postgres:
    image: postgres:16-alpine
    command: [ "postgres", "-c", "wal_level=logical" ]
    environment:
      POSTGRES_DB: ${VK_POSTGRES_DB:-remote}
      POSTGRES_USER: ${VK_POSTGRES_USER:-remote}
      POSTGRES_PASSWORD: ${VK_POSTGRES_PASSWORD:-remote}
    volumes:
      - vk-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${VK_POSTGRES_USER:-remote} -d ${VK_POSTGRES_DB:-remote}" ]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - vk-cloud
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # Azurite (Azure Blob Storage emulator for file attachments)
  # --------------------------------------------------------------------------
  vk-azurite:
    image: mcr.microsoft.com/azure-storage/azurite:3.35.0
    container_name: vk-azurite
    command: "azurite-blob --blobHost 0.0.0.0 --blobPort 10000 --loose --skipApiVersionCheck"
    volumes:
      - vk-azurite-data:/data
    healthcheck:
      test: nc 127.0.0.1 10000 -z
      interval: 1s
      retries: 30
    networks:
      - vk-cloud
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # Azurite Initialization (create container and configure CORS)
  # --------------------------------------------------------------------------
  vk-azurite-init:
    image: mcr.microsoft.com/azure-cli:2.83.0
    container_name: vk-azurite-init
    depends_on:
      vk-azurite:
        condition: service_healthy
    environment:
      AZURE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://vk-azurite:10000/devstoreaccount1;"
    entrypoint: /bin/sh
    command:
      - -c
      - |
        set -e
        az storage container create --name issue-attachments 2>/dev/null || true
        az storage cors add --services b --methods GET PUT POST DELETE OPTIONS --origins '*' --allowed-headers '*' --exposed-headers '*' --max-age 3600 2>/dev/null || true
        echo "Azurite CORS configured successfully"
    networks:
      - vk-cloud

  # --------------------------------------------------------------------------
  # VK Remote Server (API + Frontend)
  # --------------------------------------------------------------------------
  # TEMPORARILY DISABLED FOR TESTING BASE INFRASTRUCTURE
  # vk-remote:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.vkcloud
  #     args:
  #       VK_REPO_URL: ${VK_REPO_URL:-https://github.com/BloopAI/vibe-kanban.git}
  #       VK_BRANCH: ${VK_BRANCH:-v0.1.15-20260218201323}
  #       FEATURES: ${FEATURES:-}
  #       POSTHOG_API_KEY: ${POSTHOG_API_KEY:-}
  #       POSTHOG_API_ENDPOINT: ${POSTHOG_API_ENDPOINT:-}
  #   container_name: vk-remote
  #   depends_on:
  #     vk-postgres:
  #       condition: service_healthy
  #     vk-azurite-init:
  #       condition: service_completed_successfully
  #   environment:
  #     # Server configuration
  #     RUST_LOG: ${RUST_LOG:-info,remote=info}
  #     SERVER_DATABASE_URL: postgres://${VK_POSTGRES_USER:-remote}:${VK_POSTGRES_PASSWORD:-remote}@vk-postgres:5432/${VK_POSTGRES_DB:-remote}
  #     SERVER_LISTEN_ADDR: 0.0.0.0:8081
  #     SERVER_PUBLIC_BASE_URL: ${PUBLIC_BASE_URL}
  #
  #     # ElectricSQL configuration
  #     ELECTRIC_URL: http://vk-electric:3000
  #     ELECTRIC_ROLE_PASSWORD: ${ELECTRIC_ROLE_PASSWORD:-remote}
  #
  #     # OAuth providers (at least one required)
  #     GITHUB_OAUTH_CLIENT_ID: ${GITHUB_OAUTH_CLIENT_ID}
  #     GITHUB_OAUTH_CLIENT_SECRET: ${GITHUB_OAUTH_CLIENT_SECRET}
  #     GOOGLE_OAUTH_CLIENT_ID: ${GOOGLE_OAUTH_CLIENT_ID:-}
  #     GOOGLE_OAUTH_CLIENT_SECRET: ${GOOGLE_OAUTH_CLIENT_SECRET:-}
  #
  #     # JWT secret (REQUIRED)
  #     VIBEKANBAN_REMOTE_JWT_SECRET: ${VIBEKANBAN_REMOTE_JWT_SECRET}
  #
  #     # Frontend build-time variables
  #     VITE_APP_BASE_URL: ${PUBLIC_BASE_URL}
  #     VITE_API_BASE_URL: ${PUBLIC_BASE_URL}
  #
  #     # Azure Storage (Azurite)
  #     AZURE_STORAGE_ACCOUNT_NAME: ${AZURE_STORAGE_ACCOUNT_NAME:-devstoreaccount1}
  #     AZURE_STORAGE_ACCOUNT_KEY: ${AZURE_STORAGE_ACCOUNT_KEY:-Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==}
  #     AZURE_STORAGE_CONTAINER_NAME: ${AZURE_STORAGE_CONTAINER_NAME:-issue-attachments}
  #     AZURE_STORAGE_ENDPOINT_URL: ${AZURE_STORAGE_ENDPOINT_URL:-http://vk-azurite:10000/devstoreaccount1}
  #     AZURE_STORAGE_PUBLIC_ENDPOINT_URL: ${AZURE_STORAGE_PUBLIC_ENDPOINT_URL:-http://localhost:10000/devstoreaccount1}
  #
  #     # Optional integrations
  #     LOOPS_EMAIL_API_KEY: ${LOOPS_EMAIL_API_KEY:-}
  #     GITHUB_APP_ID: ${GITHUB_APP_ID:-}
  #     GITHUB_APP_PRIVATE_KEY: ${GITHUB_APP_PRIVATE_KEY:-}
  #     GITHUB_APP_WEBHOOK_SECRET: ${GITHUB_APP_WEBHOOK_SECRET:-}
  #     GITHUB_APP_SLUG: ${GITHUB_APP_SLUG:-}
  #     R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID:-}
  #     R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY:-}
  #     R2_REVIEW_ENDPOINT: ${R2_REVIEW_ENDPOINT:-}
  #     R2_REVIEW_BUCKET: ${R2_REVIEW_BUCKET:-}
  #     REVIEW_WORKER_BASE_URL: ${REVIEW_WORKER_BASE_URL:-}
  #     STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
  #     STRIPE_TEAM_SEAT_PRICE_ID: ${STRIPE_TEAM_SEAT_PRICE_ID:-}
  #     STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
  #     STRIPE_FREE_SEAT_LIMIT: ${STRIPE_FREE_SEAT_LIMIT:-1}
  #   ports:
  #     - "${REMOTE_SERVER_PORTS:-127.0.0.1:3000:8081}"
  #   networks:
  #     - vk-cloud
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:8081/health"]
  #     interval: 10s
  #     timeout: 10s
  #     retries: 30
  #     start_period: 120s

  # --------------------------------------------------------------------------
  # ElectricSQL (real-time sync service)
  # MUST start AFTER vk-remote because migrations create the electric_sync role
  # --------------------------------------------------------------------------
  # TEMPORARILY DISABLED FOR TESTING BASE INFRASTRUCTURE
  # vk-electric:
  #   image: electricsql/electric:1.3.3
  #   container_name: vk-electric
  #   working_dir: /app
  #   depends_on:
  #     vk-postgres:
  #       condition: service_healthy
  #     vk-remote:
  #       condition: service_healthy
  #   environment:
  #     DATABASE_URL: postgresql://electric_sync:${ELECTRIC_ROLE_PASSWORD:-remote}@vk-postgres:5432/${VK_POSTGRES_DB:-remote}?sslmode=disable
  #     PG_PROXY_PORT: 65432
  #     LOGICAL_PUBLISHER_HOST: vk-electric
  #     AUTH_MODE: insecure
  #     ELECTRIC_INSECURE: true
  #     ELECTRIC_MANUAL_TABLE_PUBLISHING: true
  #     ELECTRIC_USAGE_REPORTING: false
  #     ELECTRIC_FEATURE_FLAGS: allow_subqueries,tagged_subqueries
  #   volumes:
  #     - vk-electric-data:/app/persistent
  #   networks:
  #     - vk-cloud
  #   restart: on-failure

# ============================================================================
# Volumes (data persistence)
# ============================================================================
volumes:
  vk-postgres-data:
    driver: local
  vk-electric-data:
    driver: local
  vk-azurite-data:
    driver: local

# ============================================================================
# Networks
# ============================================================================
networks:
  vk-cloud:
    driver: bridge
